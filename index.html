<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Business POS Terminal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind gray-50 */
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom styling for the large total display */
        #displayTotal {
            transition: all 0.3s ease-in-out;
            font-size: 2.5rem; /* Larger font for mobile */
        }
        /* Modal backdrop styling */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 50;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6', // Blue-500
                        'secondary': '#10b981', // Emerald-500
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <script>
    // CRITICAL: YOUR DEPLOYED GOOGLE APPS SCRIPT URL
    const FORM_URL = 'https://script.google.com/macros/s/AKfycbwDaROC791s5DfluLFOEVyQaQPJKva6iwbF0Sq9faU25HvKmRhuTVzx7Aezyji1p1aeXQ/exec';
    
    // User/Business Email for Subscription Check
    const BUSINESS_EMAIL = 'Pascollanm@gmail.com'; 
    </script>

    <!-- Subscription Alert Modal -->
    <div id="renewalModal" class="modal-backdrop hidden transition duration-300 ease-in-out">
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white card rounded-xl max-w-lg w-full p-6 space-y-4 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
                <h3 id="modalTitle" class="text-2xl font-bold text-red-600 border-b pb-2">Subscription Warning</h3>
                <p id="modalMessage" class="text-gray-700"></p>
                
                <!-- Renewal Form -->
                <form id="renewalForm" class="space-y-3 pt-3 border-t">
                    <input type="hidden" name="action" value="renew">
                    <input type="hidden" name="renewalEmail" id="renewalEmail" value="">
                    
                    <h4 class="text-lg font-semibold text-primary">Renew Now (30 Days)</h4>
                    
                    <div class="input-group">
                        <label for="businessName" class="block text-sm font-medium text-gray-700 mb-1">Business Name</label>
                        <input type="text" name="businessName" id="businessName" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div class="input-group">
                        <label for="renewalAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount Paid (KSh)</label>
                        <input type="number" name="renewalAmount" id="renewalAmount" value="2000.00" min="1" step="0.01" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary">
                    </div>
                    <div class="input-group">
                        <label for="paymentReference" class="block text-sm font-medium text-gray-700 mb-1">Payment Reference/Code</label>
                        <input type="text" name="paymentReference" id="paymentReference" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <button type="submit" class="w-full py-2 bg-secondary text-white font-bold rounded-lg hover:bg-secondary/90 transition duration-150">
                        Process Renewal (Mock Payment)
                    </button>
                    <div id="renewalStatusMessage" class="text-center mt-2 text-sm"></div>
                </form>

                <button onclick="closeRenewalModal()" class="w-full py-1 text-sm text-gray-500 hover:text-gray-700">Close POS (For now)</button>
            </div>
        </div>
    </div>


    <div class="max-w-4xl mx-auto">
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-extrabold text-primary">Smart Sales Terminal (KSh)</h1>
            <p class="text-gray-500 mt-1">Process sales quickly and record transactions instantly.</p>
        </header>

        <!-- Subscription Status Bar -->
        <div id="subscriptionBar" class="p-3 mb-6 rounded-lg text-sm flex justify-between items-center text-white font-medium bg-gray-600 transition-all duration-300">
            <span>Subscription Status: <span id="subStatus">Loading...</span></span>
            <span id="subExpiry">Expiry: N/A</span>
        </div>

        <form id="salesForm" class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Transaction Details Column (Left/Top) -->
            <div class="lg:col-span-2 space-y-4 card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold border-b pb-2 text-gray-700">Transaction Details (POS)</h2>

                <!-- Customer Details -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Customer Name (Optional)</label>
                        <input type="text" name="customerName" id="customerName" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div class="input-group">
                        <label for="customerEmail" class="block text-sm font-medium text-gray-700 mb-1">Customer Email (Required for Receipt)</label>
                        <input type="email" name="customerEmail" id="customerEmail" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                </div>

                <!-- Product Details -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="input-group sm:col-span-1">
                        <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" name="productName" id="productName" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div class="input-group sm:col-span-1">
                        <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                        <input type="number" name="quantity" id="quantity" value="1" min="1" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div class="input-group sm:col-span-1">
                        <label for="unitPrice" class="block text-sm font-medium text-gray-700 mb-1">Unit Price (KSh)</label>
                        <input type="number" name="unitPrice" id="unitPrice" value="0.00" min="0" step="0.01" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                </div>

                <!-- Hidden inputs for calculated values -->
                <input type="hidden" name="calculatedTotal" id="calculatedTotal" value="0.00">
                <input type="hidden" name="changeGiven" id="changeGiven" value="0.00">
                <input type="hidden" name="creditDue" id="creditDue" value="0.00">
                <input type="hidden" name="action" value="recordSale"> <!-- Added action for clarity -->
            </div>
            
            <!-- Payment Column (Right/Side) -->
            <div class="space-y-4 lg:col-span-1 card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold border-b pb-2 text-gray-700">Payment & Summary (Cash)</h2>

                <!-- Total Display -->
                <div class="text-center bg-primary/10 p-4 rounded-xl">
                    <p class="text-md text-gray-600 font-medium">Sale Total:</p>
                    <div id="displayTotal" class="text-primary font-extrabold">KSh 0.00</div>
                </div>

                <!-- Cash Tendered Input (Single payment field now) -->
                <div class="input-group">
                    <label for="amountPaid" class="block text-sm font-medium text-gray-700 mb-1">Cash Tendered (KSh)</label>
                    <input type="number" name="amountPaid" id="amountPaid" value="0.00" min="0" step="0.01" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                </div>
                
                <!-- Change/Credit Summary -->
                <div class="space-y-2 pt-2 border-t mt-4">
                    <div class="flex justify-between items-center text-md font-medium">
                        <span class="text-gray-600">Change Given:</span>
                        <span id="displayChange" class="text-secondary font-bold">KSh 0.00</span>
                    </div>
                    <div class="flex justify-between items-center text-md font-medium">
                        <span class="text-gray-600">Credit Due:</span>
                        <span id="displayCredit" class="text-red-500 font-bold">KSh 0.00</span>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="w-full py-3 mt-4 bg-primary text-white font-bold rounded-lg hover:bg-primary/90 transition duration-150 transform hover:scale-[1.01]">
                    Record Sale & Send Receipt
                </button>
                
                <!-- Submission Status Message -->
                <div id="statusMessage" class="text-center mt-3 text-sm"></div>
            </div>

        </form>
    </div>

    <script>
        const form = document.getElementById('salesForm');
        const renewalForm = document.getElementById('renewalForm');
        const renewalModal = document.getElementById('renewalModal');
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const subBar = document.getElementById('subscriptionBar');
        const subStatusSpan = document.getElementById('subStatus');
        const subExpirySpan = document.getElementById('subExpiry');
        const renewalStatusMessage = document.getElementById('renewalStatusMessage');

        // POS Elements
        const quantityInput = document.getElementById('quantity');
        const unitPriceInput = document.getElementById('unitPrice');
        const amountPaidInput = document.getElementById('amountPaid');
        const displayTotal = document.getElementById('displayTotal');
        const displayChange = document.getElementById('displayChange');
        const displayCredit = document.getElementById('displayCredit');
        const calculatedTotalHidden = document.getElementById('calculatedTotal');
        const changeGivenHidden = document.getElementById('changeGiven');
        const creditDueHidden = document.getElementById('creditDue');
        const statusMessageDiv = document.getElementById('statusMessage');

        /**
         * Opens the renewal modal with specific message and styling.
         * @param {string} status - The subscription status.
         * @param {string} expiryDate - The subscription end date.
         */
        function openRenewalModal(status, expiryDate) {
            document.getElementById('renewalEmail').value = BUSINESS_EMAIL;
            
            renewalModal.classList.remove('hidden');
            // Animate In
            setTimeout(() => {
                renewalModal.style.opacity = '1';
                modalContent.style.transform = 'scale(1)';
                modalContent.style.opacity = '1';
            }, 10); 

            let bgColor = 'bg-red-600';
            
            if (status === 'EXPIRED') {
                modalTitle.textContent = "ACCOUNT EXPIRED!";
                modalMessage.textContent = `Your subscription expired on ${expiryDate}. Renew immediately to resume service.`;
                bgColor = 'bg-red-600'; // Red for expired
                form.querySelector('button[type="submit"]').disabled = true;
                statusMessageDiv.textContent = "Subscription expired. POS usage disabled.";
            } else if (status === 'Expiring Soon') {
                modalTitle.textContent = "RENEWAL REMINDER!";
                modalMessage.textContent = `Your subscription is expiring soon on ${expiryDate}. Renew now to avoid interruption.`;
                bgColor = 'bg-amber-500'; // Amber for expiring soon
                form.querySelector('button[type="submit"]').disabled = false;
                statusMessageDiv.textContent = "";
            }

            subBar.classList.remove('bg-gray-600', 'bg-secondary', 'bg-red-600', 'bg-amber-500');
            subBar.classList.add(bgColor);
        }
        
        /**
         * Closes the renewal modal.
         */
        function closeRenewalModal() {
            // Animate Out
            modalContent.style.transform = 'scale(0.95)';
            modalContent.style.opacity = '0';
            setTimeout(() => {
                renewalModal.classList.add('hidden');
                renewalModal.style.opacity = '0';
            }, 300);
        }


        /**
         * Fetches and displays the subscription status and POS metrics.
         */
        async function fetchDashboardData() {
            try {
                const url = `${FORM_URL}?email=${encodeURIComponent(BUSINESS_EMAIL)}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.subscription) {
                    const sub = data.subscription;
                    subStatusSpan.textContent = sub.status;
                    subExpirySpan.textContent = `Expires: ${sub.end}`;
                    
                    subBar.classList.remove('bg-gray-600', 'bg-secondary', 'bg-red-600', 'bg-amber-500');

                    if (sub.status === 'Active') {
                        subBar.classList.add('bg-secondary');
                        form.querySelector('button[type="submit"]').disabled = false;
                        statusMessageDiv.textContent = "";
                    } else if (sub.status === 'Expiring Soon') {
                        subBar.classList.add('bg-amber-500');
                        openRenewalModal(sub.status, sub.end);
                        // Sale is still allowed when expiring soon
                        form.querySelector('button[type="submit"]').disabled = false; 
                    } else if (sub.status === 'EXPIRED' || sub.status === 'Unsubscribed' || sub.status === 'Sheet Error' || sub.status === 'Unknown') {
                        subBar.classList.add('bg-red-600');
                        openRenewalModal('EXPIRED', sub.end); 
                        // Sale is disabled if expired or status is unknown/error
                        form.querySelector('button[type="submit"]').disabled = true;
                    } 
                }

            } catch (error) {
                console.error("Error fetching dashboard data:", error);
                subStatusSpan.textContent = "Connection Error";
                subBar.classList.add('bg-red-600');
            }
        }


        // POS Logic 

        /**
         * Calculates the Sale Total, Change Given, and Credit Due.
         */
        function calculateChange() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const amountPaid = parseFloat(amountPaidInput.value) || 0;

            const total = quantity * unitPrice;
            const difference = amountPaid - total;

            let changeGiven = 0;
            let creditDue = 0;

            if (difference > 0) {
                changeGiven = difference; // Customer overpaid, give change
            } else if (difference < 0) {
                creditDue = Math.abs(difference); // Customer underpaid, credit due
            }

            // Update DOM displays
            displayTotal.textContent = `KSh ${total.toFixed(2)}`;
            displayChange.textContent = `KSh ${changeGiven.toFixed(2)}`;
            displayCredit.textContent = `KSh ${creditDue.toFixed(2)}`;

            // Update hidden form fields for submission
            calculatedTotalHidden.value = total.toFixed(2);
            changeGivenHidden.value = changeGiven.toFixed(2);
            creditDueHidden.value = creditDue.toFixed(2);
        }

        /**
         * Handles POS form submission via AJAX.
         */
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Re-check if button is disabled (should be handled by fetchDashboardData)
            if(e.target.querySelector('button[type="submit"]').disabled) return; 

            statusMessageDiv.innerHTML = '<span class="text-primary font-medium">Processing transaction...</span>';
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            const formData = new FormData(form);
            const data = new URLSearchParams(formData);

            try {
                const response = await fetch(FORM_URL, {
                    method: 'POST',
                    body: data,
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });

                const result = await response.json();
                
                if (result.result === 'Success') {
                    statusMessageDiv.innerHTML = `<span class="text-secondary font-bold">✅ Success! ${result.message}</span>`;
                    form.reset();
                    document.getElementById('amountPaid').value = '0.00';
                    calculateChange();
                } else {
                    statusMessageDiv.innerHTML = `<span class="text-red-500 font-bold">❌ Error: ${result.message}</span>`;
                }

            } catch (error) {
                console.error("Submission Error:", error);
                statusMessageDiv.innerHTML = '<span class="text-red-500 font-bold">❌ Network Error. Could not connect to the backend script.</span>';
            } finally {
                // Re-fetch status to potentially re-enable the button if renewal happened in the background
                await fetchDashboardData(); 
                setTimeout(() => { statusMessageDiv.textContent = ''; }, 5000);
            }
        });

        /**
         * Handles Renewal form submission via AJAX.
         */
        renewalForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            renewalStatusMessage.innerHTML = '<span class="text-primary font-medium">Processing renewal...</span>';
            const submitButton = renewalForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            const formData = new FormData(renewalForm);
            const data = new URLSearchParams(formData);
            
            try {
                const response = await fetch(FORM_URL, {
                    method: 'POST',
                    body: data,
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });

                const result = await response.json();
                
                if (result.result === 'Success') {
                    renewalStatusMessage.innerHTML = `<span class="text-secondary font-bold">✅ Success! ${result.message}</span>`;
                    renewalForm.reset();
                    // Crucial: Re-fetch status and close modal
                    await fetchDashboardData(); 
                    closeRenewalModal();
                } else {
                    renewalStatusMessage.innerHTML = `<span class="text-red-500 font-bold">❌ Renewal Failed: ${result.message}</span>`;
                }

            } catch (error) {
                console.error("Renewal Error:", error);
                renewalStatusMessage.innerHTML = '<span class="text-red-500 font-bold">❌ Network Error. Could not process renewal.</span>';
            } finally {
                submitButton.disabled = false;
            }
        });


        document.addEventListener('DOMContentLoaded', () => {
            // Attach POS input listeners
            [quantityInput, unitPriceInput, amountPaidInput].forEach(input => {
                input.addEventListener('input', calculateChange);
            });
            calculateChange();
            
            // Fetch subscription status immediately
            fetchDashboardData();
        });

    </script>
</body>
</html>
